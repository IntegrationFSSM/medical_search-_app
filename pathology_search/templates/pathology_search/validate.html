<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Validation - {{ pathology_info.name|default:"Pathologie" }}</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100%;
            width: 100vw !important;
            max-width: 100vw !important;
            overflow-x: hidden;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Forcer le contenu √† prendre toute la largeur */
        .min-h-screen {
            width: 100vw !important;
            max-width: 100vw !important;
        }
        
        #pathologyFormContainer {
            width: 100%;
            max-width: 100%;
        }
        
        /* Forcer tous les conteneurs, divs, sections, etc. √† prendre toute la largeur */
        div, section, fieldset, form, main, article, header, footer {
            max-width: 100vw !important;
        }
        
        /* Si les HTML ont des classes avec max-width */
        .container, .max-w-7xl, .max-w-6xl, .max-w-5xl, .max-w-4xl, .max-w-3xl, .max-w-2xl, .max-w-xl, .mx-auto {
            max-width: 100vw !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
            width: 100vw !important;
        }
        
        /* Override tout style inline avec width */
        [style*="width"] {
            width: 100vw !important;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 24px;
            background-color: #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 50%, #10b981 100%);
            background-size: 200% 100%;
            animation: shimmer 2s linear infinite;
            transition: width 0.5s ease;
            width: 0%;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
    </style>
</head>
<body class="m-0 p-0 bg-gray-50">
    <!-- Page Full Width - No Container -->
    <div class="min-h-screen m-0 p-0">
        <!-- Header violet sticky compact et professionnel -->
        {% if patient %}
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-2 px-3 sticky top-0 z-50 shadow-md">
            <div class="w-full">
                <div class="flex flex-col gap-1.5">
                    <!-- Ligne 1: Titre, Info patient et Boutons d'action sur une seule ligne -->
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <!-- Titre et Score -->
                        <div class="flex items-center gap-2">
                            <h3 class="text-base font-semibold flex items-center">
                                <i class="fas fa-clipboard-check text-sm mr-1.5"></i>
                                Validation {{ current_index|add:1 }}/{{ total_results }}
                            </h3>
                            {% if pathology_info.similarity %}
                            <span class="bg-white bg-opacity-20 px-2 py-0.5 rounded text-xs font-medium">
                                {{ pathology_info.similarity|floatformat:1 }}%
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Info Patient compacte -->
                        <div class="flex items-center gap-3 text-xs">
                            <span><i class="fas fa-user text-xs mr-1"></i><strong>{{ patient.nom }} {{ patient.prenom }}</strong></span>
                            <span><i class="fas fa-id-card text-xs mr-1"></i>{{ patient.numero_dossier }}</span>
                            {% if patient.date_naissance %}
                            <span><i class="fas fa-calendar text-xs mr-1"></i>{{ patient.date_naissance|date:"d/m/Y" }}</span>
                            {% endif %}
                        </div>
                        
                        <!-- Boutons d'action -->
                        <div class="flex items-center gap-2">
                            <button 
                                onclick="window.validerFormulaire()"
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 px-4 rounded transition shadow-sm flex items-center text-sm"
                            >
                                <i class="fas fa-check text-xs mr-1.5"></i>
                                VALIDER
                            </button>
                            <button 
                                onclick="window.nonValiderFormulaire()"
                                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 px-4 rounded transition shadow-sm flex items-center text-sm"
                            >
                                <i class="fas fa-times text-xs mr-1.5"></i>
                                NON VALIDER
                            </button>
                            <button 
                                onclick="window.location.href='{% url 'pathology_search:index' %}'"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-1.5 px-3 rounded transition text-xs"
                            >
                                <i class="fas fa-home text-xs mr-1"></i>Accueil
                            </button>
                        </div>
                    </div>
                    
                    <!-- Ligne 2: Requ√™te et Pathologie (si disponibles) -->
                    {% if query or pathology_info.name %}
                    <div class="flex items-center gap-4 text-xs opacity-90 pt-1 border-t border-white border-opacity-20">
                        {% if query %}
                        <span><i class="fas fa-search text-xs mr-1"></i><span class="font-medium">{{ query }}</span></span>
                        {% endif %}
                        {% if pathology_info.name %}
                        <span><i class="fas fa-disease text-xs mr-1"></i><span class="font-medium">{{ pathology_info.name }}</span></span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 sticky top-0 z-50 shadow-lg">
            <h3 class="text-xl font-bold flex items-center">
                <i class="fas fa-file-medical-alt mr-2"></i>
                <span>Formulaire d'√âvaluation{% if pathology_info.name %} - {{ pathology_info.name }}{% endif %}</span>
            </h3>
        </div>
        {% endif %}
        
        <!-- Contenu du formulaire - Avec marges -->
        <div class="w-full bg-white">
            <div id="pathologyFormContainer" class="px-4 py-3">
                {{ html_content|safe }}
            </div>
        </div>
    </div>

    <script>
    // Variables globales
    const pathologyInfo = {{ pathology_info_json|safe }};
    const patientId = {{ patient_id|default:"null" }};
    const medecinId = {{ medecin_id|default:"null" }};
    const currentIndex = {{ current_index|default:"0" }};
    const totalResults = {{ total_results|default:"1" }};
    const isLast = {{ is_last|default:"false"|lower }};

    // Fonction pour obtenir le cookie CSRF
    function getCookie(name) {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
        
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Attendre que le DOM soit compl√®tement charg√©
    document.addEventListener('DOMContentLoaded', function() {
        // Cr√©er les fonctions globales pour les boutons principaux VALIDE/NON VALIDE
        
        window.validerFormulaire = function() {
            console.log('validerFormulaire() appel√©e - G√©n√©ration du diagnostic');
            handleValidation();
        };
        
        window.nonValiderFormulaire = function() {
            console.log('nonValiderFormulaire() appel√©e - Passage au suivant ou retour');
            handleSkip();
        };
        
        console.log('‚úÖ Fonctions de validation globales cr√©√©es pour validate.html');
    });

    // Fonction pour collecter les donn√©es du formulaire
    function collectFormData() {
        const formData = {};
        
        // Collecter toutes les cases coch√©es
        document.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
            const label = checkbox.nextElementSibling || checkbox.previousElementSibling;
            const text = label ? label.textContent.trim() : checkbox.value;
            
            // Grouper par section si possible
            const fieldset = checkbox.closest('fieldset');
            const sectionName = fieldset ? (fieldset.querySelector('legend')?.textContent.trim() || 'Crit√®res') : 'Crit√®res';
            
            if (!formData[sectionName]) {
                formData[sectionName] = [];
            }
            formData[sectionName].push(text);
        });
        
        // Collecter les inputs texte
        document.querySelectorAll('input[type="text"], textarea').forEach(input => {
            if (input.value.trim()) {
                const label = input.labels?.[0]?.textContent.trim() || input.name || input.placeholder;
                if (label) {
                    formData[label] = input.value.trim();
                }
            }
        });
        
        // Collecter les select
        document.querySelectorAll('select').forEach(select => {
            if (select.value) {
                const label = select.labels?.[0]?.textContent.trim() || select.name;
                if (label) {
                    formData[label] = select.options[select.selectedIndex].text;
                }
            }
        });
        
        return formData;
    }

    // G√©rer la validation
    async function handleValidation() {
        // V√©rifier qu'un patient est s√©lectionn√©
        if (!patientId) {
            Swal.fire({
                icon: 'warning',
                title: 'Patient requis',
                text: 'Veuillez s√©lectionner un patient depuis la page principale avant de valider une pathologie.',
                confirmButtonColor: '#10b981'
            }).then(() => {
                window.location.href = '{% url "pathology_search:index" %}';
            });
            return;
        }
        
        // Collecter les donn√©es du formulaire
        const formData = collectFormData();
        
        if (Object.keys(formData).length === 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Formulaire vide',
                text: 'Veuillez remplir au moins un crit√®re avant de valider.',
                confirmButtonColor: '#10b981'
            });
            return;
        }
        
        // Afficher le loading avec animation
        Swal.fire({
            title: '<i class="fas fa-file-medical fa-spin text-purple-600 mr-2"></i> G√©n√©ration du Diagnostic Summary',
            html: `
                <p class="mb-4">Analyse en cours des crit√®res s√©lectionn√©s...</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="aiProgressBar"></div>
                </div>
                <p class="text-sm text-gray-600 mt-4">Cr√©ation du r√©sum√© diagnostique en cours...</p>
            `,
            allowOutsideClick: false,
            showConfirmButton: false,
            didOpen: () => {
                simulateAIProgress();
            }
        });
        
        try {
            // Appeler l'API pour g√©n√©rer le diagnostic
            const response = await fetch('{% url "pathology_search:validate_action" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    action: 'validate',
                    form_data: formData,
                    pathology_name: pathologyInfo.name,
                    patient_id: patientId,
                    medecin_id: medecinId,
                    direct_access: false,  // C'est une validation depuis la recherche
                    current_index: currentIndex
                })
            });
            
            const data = await response.json();
            
            if (data.success && data.diagnosis_id) {
                // Rediriger vers la page de diagnostic
                window.location.href = `/diagnosis/${data.diagnosis_id}/`;
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: data.error || 'Une erreur est survenue lors de la g√©n√©ration du diagnostic.',
                    confirmButtonColor: '#10b981'
                });
            }
        } catch (error) {
            Swal.fire({
                icon: 'error',
                title: 'Erreur de connexion',
                text: 'Impossible de g√©n√©rer le diagnostic: ' + error.message,
                confirmButtonColor: '#10b981'
            });
        }
    }

    // Simuler la progression de l'IA
    function simulateAIProgress() {
        let progress = 0;
        const progressBar = document.getElementById('aiProgressBar');
        
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
        }, 500);
        
        // Nettoyer l'intervalle apr√®s 30 secondes
        setTimeout(() => clearInterval(interval), 30000);
    }

    // G√©rer le skip (ne pas valider et passer au suivant ou retourner)
    async function handleSkip() {
        // Collecter les crit√®res coch√©s avant de partir
        const formData = collectFormData();
        
        console.log('üìä Crit√®res coch√©s avant NON VALIDE:', formData);
        
        // Sauvegarder les crit√®res m√™me si on ne valide pas
        try {
            const response = await fetch('{% url "pathology_search:validate_action" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    action: 'skip',
                    current_index: currentIndex,
                    form_data: formData,
                    direct_access: false,
                    pathology_name: pathologyInfo.name || ''
                })
            });
            
            const data = await response.json();
            console.log('‚úÖ Crit√®res sauvegard√©s pour NON VALIDE:', data);
        } catch (error) {
            console.error('‚ùå Erreur lors de la sauvegarde des crit√®res:', error);
        }
        
        // Rediriger directement sans Sweet Alert
        window.location.href = '{% url "pathology_search:results_selection" %}';
    }
    </script>
</body>
</html>
