{% extends "pathology_search/base.html" %}
{% load custom_filters %}

{% block title %}Plan de Traitement - {{ pathology_name }}{% endblock %}

{% block extra_css %}
<style>
    .diagnosis-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 1.5rem;
        border-radius: 15px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }
    
    @media (min-width: 640px) {
        .diagnosis-container {
            padding: 3rem;
            border-radius: 20px;
        }
    }
    
    .diagnosis-card {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    @media (min-width: 640px) {
        .diagnosis-card {
            border-radius: 15px;
            padding: 2.5rem;
        }
    }
    
    .diagnosis-header {
        border-bottom: 3px solid #667eea;
        padding-bottom: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .diagnosis-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #667eea;
    }
    
    .diagnosis-text {
        line-height: 1.8;
        color: #374151;
        white-space: pre-wrap;
    }
    
    .confidence-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        border-radius: 50px;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .confidence-high {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .confidence-medium {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .confidence-low {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .form-data-item {
        background: white;
        padding: 0.75rem 1rem;
        margin: 0.5rem 0;
        border-radius: 8px;
        border-left: 3px solid #667eea;
        font-size: 0.9rem;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .diagnosis-card {
        animation: fadeInUp 0.6s ease-out;
    }
    
    .print-button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: all 0.3s ease;
    }
    
    .print-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
    }
    
    @media print {
        .print-button, nav, footer {
            display: none;
        }
        
        .diagnosis-container {
            box-shadow: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="diagnosis-container mx-auto max-w-5xl">
    <div class="diagnosis-card">
        <!-- Header -->
        <div class="diagnosis-header">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4">
                <div class="flex-1">
                    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                        <i class="fas fa-prescription-bottle-alt text-green-600 mr-2 sm:mr-3"></i>
                        Plan de Traitement
                    </h1>
                    <h2 class="text-lg sm:text-xl md:text-2xl text-gray-600 font-semibold">{{ pathology_name }}</h2>
                </div>
                <div class="text-left sm:text-right">
                    <p class="text-xs sm:text-sm text-gray-500 mt-2">
                        <i class="far fa-clock mr-1"></i> {{ timestamp }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Informations du Patient -->
        {% if patient_nom or patient_prenom or patient_identite %}
        <div class="diagnosis-section mb-4">
            <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-user-md text-blue-600 mr-2"></i>
                Informations du Patient
            </h3>
            <div class="bg-white p-4 rounded-lg border-l-4 border-blue-500">
                {% if patient_prenom or patient_nom %}
                <p class="text-gray-700 mb-2">
                    <span class="font-semibold">Nom complet :</span> 
                    {{ patient_prenom|default:"" }} {{ patient_nom|default:"" }}
                </p>
                {% endif %}
                {% if patient_identite %}
                <p class="text-gray-700">
                    <span class="font-semibold">Identit√© (N¬∞ dossier) :</span> 
                    {{ patient_identite }}
                </p>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Plan de Traitement -->
        {% if success %}
        <div class="diagnosis-section">
            <!-- Badge de statut -->
            {% if consultation_statut == 'valide' %}
            <div class="mb-4 bg-green-50 border-l-4 border-green-500 p-4 rounded-lg">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-600 text-xl mr-3"></i>
                    <div>
                        <p class="font-bold text-green-800">Plan de traitement valid√©</p>
                        <p class="text-sm text-green-600">Ce plan a √©t√© valid√© par le m√©decin et sera utilis√© pour le rapport PDF.</p>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Zone √©ditable pour le plan de traitement -->
            <div class="relative">
                <div id="treatment-content" class="diagnosis-text" style="line-height: 2; font-size: 15px; min-height: 200px; padding: 1.5rem; background: white; border-radius: 8px; border: 2px solid #e5e7eb;" contenteditable="true"></div>
                <div class="mt-2 text-xs text-gray-500 flex items-center">
                    <i class="fas fa-info-circle mr-1"></i>
                    <span>Vous pouvez modifier directement le texte ci-dessus</span>
                </div>
            </div>
            
            <!-- Notes optionnelles du m√©decin -->
            <div class="mt-6">
                <label for="notes-medecin" class="block text-sm font-semibold text-gray-700 mb-2">
                    <i class="fas fa-stethoscope mr-2 text-blue-600"></i>
                    Notes du m√©decin (optionnel)
                </label>
                <textarea id="notes-medecin" 
                          rows="4" 
                          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-y"
                          placeholder="Ajoutez vos notes ou commentaires pour le rapport...">{{ notes_medecin }}</textarea>
                <p class="mt-1 text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Ces notes seront incluses dans le rapport PDF
                </p>
            </div>
            
            <!-- Boutons d'action pour le m√©decin -->
            <div class="mt-6 flex flex-wrap gap-3">
                <button id="btn-validate" 
                        class="bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105">
                    <i class="fas fa-check-circle mr-2"></i>
                    <span>Valider</span>
                </button>
                
                <button id="btn-save-modification" 
                        class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center shadow-lg hover:shadow-xl transform hover:scale-105">
                    <i class="fas fa-save mr-2"></i>
                    <span>Sauvegarder les modifications</span>
                </button>
            </div>
        </div>
        {% else %}
        <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-red-600 text-2xl mr-3 mt-1"></i>
                <div>
                    <h3 class="text-lg font-bold text-red-800 mb-2">Erreur lors de la g√©n√©ration du diagnostic summary</h3>
                    <p class="text-red-700 mb-2 font-semibold">{{ diagnosis_result.error|default:"Impossible de g√©n√©rer le r√©sum√© diagnostique pour cette pathologie." }}</p>
                    {% if diagnosis_result.error_detail %}
                    <div class="bg-red-100 p-3 rounded mt-2 mb-2">
                        <p class="text-xs text-red-800 font-mono">{{ diagnosis_result.error_detail }}</p>
                    </div>
                    {% endif %}
                    <p class="text-sm text-red-600 mt-1">Veuillez v√©rifier que votre cl√© API est correctement configur√©e dans le fichier .env et r√©essayer.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Donn√©es du Formulaire -->
        <div class="diagnosis-section">
            <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-3 sm:mb-4 flex items-center">
                <i class="fas fa-clipboard-check text-purple-600 mr-2"></i>
                Crit√®res Diagnostiques Valid√©s
            </h3>
            {% if form_data %}
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
                    {% for key, value in form_data.items %}
                        <div class="relative bg-gradient-to-br from-purple-50 to-blue-50 border-l-4 border-purple-500 rounded-lg p-3 sm:p-4 shadow-sm hover:shadow-md transition-shadow duration-300">
                            <!-- Titre du crit√®re -->
                            <div class="flex items-start gap-2 mb-2">
                                <div class="flex-shrink-0 w-7 h-7 sm:w-8 sm:h-8 bg-purple-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-check text-white text-xs sm:text-sm"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h4 class="font-bold text-gray-800 text-sm sm:text-base leading-tight break-words">{{ key }}</h4>
                                    <div class="h-0.5 w-12 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full mt-1"></div>
                                </div>
                            </div>
                            
                            <!-- Valeurs -->
                            <div class="ml-0 sm:ml-9">
                                {% if value is iterable and value is not string %}
                                    <div class="space-y-1.5">
                                        {% for item in value %}
                                            <div class="flex items-start gap-1.5 bg-white bg-opacity-60 rounded-lg p-2">
                                                <i class="fas fa-check-circle text-green-500 text-xs mt-0.5 flex-shrink-0"></i>
                                                <span class="text-gray-700 text-xs sm:text-sm leading-relaxed">{{ item|clean_text }}</span>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <div class="bg-white bg-opacity-60 rounded-lg p-2">
                                        <p class="text-gray-700 text-xs sm:text-sm">{{ value|clean_text }}</p>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- D√©coration -->
                            <div class="absolute top-1.5 right-1.5 opacity-5">
                                <i class="fas fa-stethoscope text-purple-600 text-xl sm:text-2xl"></i>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3"></i>
                        <p class="text-gray-600 italic">Aucune donn√©e de formulaire disponible.</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Informations de Recherche - Cach√©es par d√©faut -->
        <div class="diagnosis-section bg-purple-50 border-purple-200 hidden">
            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center">
                <i class="fas fa-search text-purple-600 mr-2"></i>
                R√©sultat de la Recherche
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Fichier Source</p>
                    <p class="font-semibold text-gray-800">{{ result.file_name }}</p>
                </div>
                <div class="bg-white p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Similarit√©</p>
                    <p class="font-semibold text-gray-800">{{ result.similarity|floatformat:4 }}</p>
                </div>
                <div class="bg-white p-3 rounded-lg">
                    <p class="text-sm text-gray-500">Localisation</p>
                    <p class="font-semibold text-gray-800">{{ result.location }}</p>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3 mt-6 sm:mt-8 pt-4 sm:pt-6 border-t border-gray-200">
            <a href="{% url 'pathology_search:index' %}" 
               class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-sm sm:text-base">
                <i class="fas fa-home mr-2"></i>
                <span>Retour √† l'accueil</span>
            </a>
            
            {% if consultation_id %}
            <a href="{% url 'pathology_search:print_report' consultation_id %}" 
               target="_blank"
               class="bg-gradient-to-r from-purple-600 to-blue-600 hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-sm sm:text-base">
                <i class="fas fa-file-pdf mr-2"></i>
                <span>Rapport Complet (PDF)</span>
            </a>
            {% endif %}
            
            <!-- Bouton pour retourner aux diagnostics non visit√©s -->
            <a href="{% url 'pathology_search:results_selection' %}" 
               class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 flex items-center justify-center text-sm sm:text-base">
                <i class="fas fa-arrow-left mr-2"></i>
                <span>Retour aux diagnostics</span>
            </a>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // üÜï Gestion du bouton retour du navigateur
    // D√©tecter d'o√π on vient pour rediriger correctement
    (function() {
        const referrer = document.referrer;
        let backUrl = '{% url "pathology_search:index" %}'; // Par d√©faut, retour √† l'accueil
        
        // V√©rifier si on vient de la page de r√©sultats de similarit√©
        if (referrer.includes('/results-selection/')) {
            backUrl = '{% url "pathology_search:results_selection" %}';
        } else if (referrer.includes('/validate/')) {
            // Si on vient du formulaire de validation, retourner aux r√©sultats
            backUrl = '{% url "pathology_search:results_selection" %}';
        }
        
        // Ajouter une entr√©e dans l'historique pour permettre le retour
        history.pushState({ page: 'diagnosis', backUrl: backUrl }, '', window.location.href);
        
        // G√©rer le bouton retour du navigateur
        window.addEventListener('popstate', function(event) {
            // Rediriger vers la bonne page selon le contexte
            if (event.state && event.state.backUrl) {
                window.location.href = event.state.backUrl;
            } else {
                window.location.href = backUrl;
            }
        });
    })();
    
    // Fonction pour formater le markdown en HTML sophistiqu√©
    function formatMarkdownToHTML(text) {
        if (!text) return '';
        
        let html = text;
        
        // Remplacer les titres ### par des sections √©l√©gantes
        html = html.replace(/###\s*(.+)/g, '<div class="mt-6 mb-4"><h4 class="text-xl font-bold text-purple-700 flex items-center border-b-2 border-purple-300 pb-2"><i class="fas fa-angle-double-right text-purple-500 mr-2"></i>$1</h4></div>');
        
        // Remplacer les titres ## par des sections principales
        html = html.replace(/##\s*(.+)/g, '<div class="mt-8 mb-4"><h3 class="text-2xl font-bold text-purple-800 flex items-center"><i class="fas fa-prescription-bottle-alt text-purple-600 mr-3"></i>$1</h3><div class="h-1 bg-gradient-to-r from-purple-500 to-blue-500 rounded-full mt-2 w-24"></div></div>');
        
        // Remplacer les titres # par des sections majeures
        html = html.replace(/#\s*(.+)/g, '<div class="mt-6 mb-4"><h2 class="text-3xl font-bold text-gray-800">$1</h2></div>');
        
        // Remplacer **texte** par du texte en gras avec style
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong class="text-purple-900 font-bold">$1</strong>');
        
        // Remplacer les listes num√©rot√©es avec style √©l√©gant
        html = html.replace(/^(\d+)\.\s+(.+)$/gm, function(match, num, text) {
            return `<div class="flex items-start my-3 p-3 bg-white rounded-lg border-l-4 border-purple-400 shadow-sm hover:shadow-md transition-shadow">
                        <span class="flex-shrink-0 w-8 h-8 bg-gradient-to-br from-purple-500 to-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm mr-3">${num}</span>
                        <span class="flex-1 text-gray-700">${text}</span>
                    </div>`;
        });
        
        // Remplacer les listes √† puces avec des ic√¥nes
        html = html.replace(/^-\s+(.+)$/gm, '<div class="flex items-start my-2 pl-4"><i class="fas fa-check-circle text-green-500 mr-3 mt-1"></i><span class="text-gray-700">$1</span></div>');
        
        // Remplacer les emojis m√©dicaux par des ic√¥nes √©l√©gantes
        html = html.replace(/üíä/g, '<i class="fas fa-pills text-purple-500 mx-1"></i>');
        html = html.replace(/‚ö†Ô∏è/g, '<i class="fas fa-exclamation-triangle text-yellow-500 mx-1"></i>');
        html = html.replace(/üìä/g, '<i class="fas fa-chart-line text-blue-500 mx-1"></i>');
        html = html.replace(/üìã/g, '<i class="fas fa-clipboard-list text-indigo-500 mx-1"></i>');
        html = html.replace(/üéØ/g, '<i class="fas fa-bullseye text-red-500 mx-1"></i>');
        html = html.replace(/ü©∫/g, '<i class="fas fa-stethoscope text-teal-500 mx-1"></i>');
        html = html.replace(/üá´üá∑/g, '<i class="fas fa-flag text-blue-600 mx-1"></i>');
        html = html.replace(/‚úÖ/g, '<i class="fas fa-check-square text-green-600 mx-1"></i>');
        html = html.replace(/üìö/g, '<i class="fas fa-book-medical text-purple-600 mx-1"></i>');
        
        // Ajouter des sauts de ligne
        html = html.replace(/\n\n/g, '<br><br>');
        html = html.replace(/\n/g, '<br>');
        
        // Mettre en √©vidence les dosages (ex: "20 mg", "2 fois par jour")
        html = html.replace(/(\d+\s*(?:mg|g|ml|mcg|UI|comprim√©s?))/gi, '<span class="font-semibold text-indigo-700 bg-indigo-50 px-2 py-1 rounded">$1</span>');
        
        // Mettre en √©vidence les dur√©es
        html = html.replace(/(\d+\s*(?:semaines?|mois|jours?|heures?))/gi, '<span class="font-semibold text-blue-700 bg-blue-50 px-2 py-1 rounded">$1</span>');
        
        return html;
    }
    
    // Animation au chargement
    document.addEventListener('DOMContentLoaded', function() {
        // Formater et afficher le plan de traitement
        const treatmentPlan = `{{ treatment_plan|escapejs }}`;
        const treatmentContent = document.getElementById('treatment-content');
        
        if (treatmentContent && treatmentPlan && treatmentPlan.trim() !== '') {
            treatmentContent.innerHTML = formatMarkdownToHTML(treatmentPlan);
        }
        
        // üÜï Gestion des boutons d'action
        const consultationId = '{{ consultation_id }}';
        if (!consultationId) {
            // Masquer les boutons si pas de consultation
            document.getElementById('btn-validate')?.parentElement?.remove();
            return;
        }
        
        // Bouton Valider
        document.getElementById('btn-validate')?.addEventListener('click', async function() {
            const result = await Swal.fire({
                title: 'Valider le plan de traitement ?',
                text: 'Ce plan sera utilis√© pour le rapport PDF. √ätes-vous s√ªr de vouloir continuer ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10b981',
                cancelButtonColor: '#6b7280',
                confirmButtonText: '<i class="fas fa-check-circle mr-2"></i>Oui, valider',
                cancelButtonText: '<i class="fas fa-times mr-2"></i>Annuler',
                reverseButtons: true
            });
            
            if (!result.isConfirmed) {
                return;
            }
            
            const notesMedecin = document.getElementById('notes-medecin').value;
            
            try {
                const response = await fetch(`/consultation/${consultationId}/validate/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        notes_medecin: notesMedecin
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Valid√© !',
                        text: 'Le plan de traitement a √©t√© valid√© avec succ√®s.',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: data.error || 'Une erreur est survenue'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Une erreur est survenue lors de la validation'
                });
            }
        });
        
        // Bouton Sauvegarder les modifications
        document.getElementById('btn-save-modification')?.addEventListener('click', async function() {
            const modifiedContent = document.getElementById('treatment-content').innerText;
            const notesMedecin = document.getElementById('notes-medecin').value;
            
            try {
                const response = await fetch(`/consultation/${consultationId}/modify/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        plan_traitement: modifiedContent,
                        notes_medecin: notesMedecin
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Sauvegard√© !',
                        text: 'Les modifications et notes ont √©t√© sauvegard√©es avec succ√®s.',
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Erreur',
                        text: data.error || 'Une erreur est survenue'
                    });
                }
            } catch (error) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Une erreur est survenue lors de la sauvegarde'
                });
            }
        });
    });
    
    // Fonction pour r√©cup√©rer le cookie CSRF
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
        }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}

