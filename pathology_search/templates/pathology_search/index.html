{% extends 'pathology_search/base.html' %}

{% block content %}
<div class="mb-6 sm:mb-8">
    <h1 class="text-2xl sm:text-3xl md:text-4xl font-bold text-gray-900 mb-2">
        <i class="fas fa-stethoscope text-purple-600 mr-2"></i>
        Recherche de Pathologies M√©dicales
    </h1>
    <p class="text-sm sm:text-base text-gray-600">S√©lectionnez un patient puis entrez une description clinique pour identifier les pathologies correspondantes</p>
</div>

<!-- Patient Selection Section -->
<div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-4 sm:p-6 mb-6 border-l-4 border-purple-500">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 flex items-center">
            <i class="fas fa-user-md text-purple-600 mr-2"></i>
            S√©lection du Patient
        </h3>
        <button 
            type="button" 
            onclick="openCreatePatientModal()"
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center text-sm"
        >
            <i class="fas fa-user-plus mr-2"></i>
            Nouveau Patient
        </button>
    </div>
    
    <div class="space-y-3">
        <label for="patientSelect" class="block text-sm font-medium text-gray-700">
            <i class="fas fa-search mr-1"></i> Rechercher et s√©lectionner un patient
        </label>
        <select 
            id="patientSelect" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent bg-white"
            required
        >
            <option value="">-- S√©lectionnez un patient --</option>
        </select>
        
        <!-- Patient Info Display -->
        <div id="patientInfo" class="hidden mt-3 p-4 bg-white rounded-lg border-l-4 border-green-500">
            <h4 class="font-semibold text-gray-800 mb-2">
                <i class="fas fa-info-circle text-green-600 mr-2"></i>
                Informations du patient
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div>
                    <span class="text-gray-600">Nom complet :</span>
                    <span class="font-semibold ml-2" id="patientNomComplet"></span>
                </div>
                <div>
                    <span class="text-gray-600">N¬∞ Dossier :</span>
                    <span class="font-semibold ml-2" id="patientNumeroDossier"></span>
                </div>
                <div>
                    <span class="text-gray-600">Date de naissance :</span>
                    <span class="font-semibold ml-2" id="patientDateNaissanceDisplay"></span>
                </div>
                <div>
                    <span class="text-gray-600">T√©l√©phone :</span>
                    <span class="font-semibold ml-2" id="patientTelephoneDisplay"></span>
                </div>
                <div>
                    <span class="text-gray-600">Email :</span>
                    <span class="font-semibold ml-2" id="patientEmailDisplay"></span>
                </div>
            </div>
        </div>
        
        <!-- Patient History Display -->
        <div id="patientHistory" class="hidden mt-3 p-4 bg-white rounded-lg border-l-4 border-blue-500">
            <h4 class="font-semibold text-gray-800 mb-3 flex items-center justify-between">
                <span>
                    <i class="fas fa-history text-blue-600 mr-2"></i>
                    Historique des consultations
                </span>
                <span id="historyCount" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded-full"></span>
            </h4>
            <div id="historyList" class="space-y-2 max-h-60 overflow-y-auto">
                <!-- Les consultations seront ins√©r√©es ici -->
            </div>
        </div>
    </div>
</div>

<!-- M√©decin Selection Section -->
<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg shadow-md p-4 sm:p-6 mb-6 border-l-4 border-blue-500">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-800 flex items-center">
            <i class="fas fa-user-doctor text-blue-600 mr-2"></i>
            S√©lection du M√©decin
        </h3>
        <button 
            type="button" 
            onclick="openCreateMedecinModal()"
            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition flex items-center text-sm"
        >
            <i class="fas fa-user-plus mr-2"></i>
            Nouveau M√©decin
        </button>
    </div>
    
    <div class="space-y-3">
        <label for="medecinSelect" class="block text-sm font-medium text-gray-700">
            <i class="fas fa-search mr-1"></i> Rechercher et s√©lectionner un m√©decin
        </label>
        <select 
            id="medecinSelect" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white"
            required
        >
            <option value="">-- S√©lectionnez un m√©decin --</option>
        </select>
        
        <!-- M√©decin Info Display -->
        <div id="medecinInfo" class="hidden mt-3 p-4 bg-white rounded-lg border-l-4 border-blue-500">
            <h4 class="font-semibold text-gray-800 mb-2">
                <i class="fas fa-info-circle text-blue-600 mr-2"></i>
                Informations du m√©decin
            </h4>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                <div>
                    <span class="text-gray-600">Nom complet :</span>
                    <span class="font-semibold ml-2" id="medecinNomComplet"></span>
                </div>
                <div>
                    <span class="text-gray-600">Sp√©cialit√© :</span>
                    <span class="font-semibold ml-2" id="medecinSpecialiteDisplay"></span>
                </div>
                <div>
                    <span class="text-gray-600">N¬∞ Ordre :</span>
                    <span class="font-semibold ml-2" id="medecinNumeroOrdreDisplay"></span>
                </div>
                <div>
                    <span class="text-gray-600">T√©l√©phone :</span>
                    <span class="font-semibold ml-2" id="medecinTelephoneDisplay"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acc√®s Direct aux Pathologies Section -->
<div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg shadow-md p-4 sm:p-6 mb-6 border-l-4 border-emerald-500">
    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-list-check text-emerald-600 mr-2"></i>
        Acc√®s Direct aux Pathologies
    </h3>
    <p class="text-sm text-gray-600 mb-4">
        <i class="fas fa-info-circle mr-1"></i>
        S√©lectionnez directement une pathologie pour acc√©der √† son formulaire d'√©valuation
    </p>
    
    <div class="space-y-3">
        <label for="pathologySelect" class="block text-sm font-medium text-gray-700">
            <i class="fas fa-search mr-1"></i> Rechercher une pathologie
        </label>
        <select 
            id="pathologySelect" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent bg-white"
        >
            <option value="">-- S√©lectionnez une pathologie --</option>
        </select>
        
        <button 
            type="button" 
            onclick="accessPathology()"
            class="w-full bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white font-semibold py-3 px-6 rounded-lg transition flex items-center justify-center shadow-md"
        >
            <i class="fas fa-arrow-right mr-2"></i>
            Acc√©der au Formulaire
        </button>
        
        <div id="pathologyInfo" class="hidden mt-3 p-3 bg-white rounded-lg border-l-4 border-emerald-500">
            <p class="text-sm text-gray-600">
                <i class="fas fa-map-marker-alt text-emerald-600 mr-2"></i>
                <span id="pathologyLocation" class="font-medium"></span>
            </p>
        </div>
    </div>
</div>

<!-- Create Patient Modal -->
<div id="createPatientModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 sm:p-6 rounded-t-lg">
            <h3 class="text-xl font-bold flex items-center">
                <i class="fas fa-user-plus mr-2"></i>
                Nouveau Patient
            </h3>
        </div>
        
        <form id="createPatientForm" class="p-4 sm:p-6 space-y-4">
            <div>
                <label for="patientNom" class="block text-sm font-medium text-gray-700 mb-1">
                    Nom <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="patientNom" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                />
            </div>
            
            <div>
                <label for="patientPrenom" class="block text-sm font-medium text-gray-700 mb-1">
                    Pr√©nom <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="patientPrenom" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    required
                />
            </div>
            
            <div>
                <label for="newPatientDateNaissance" class="block text-sm font-medium text-gray-700 mb-1">
                    Date de naissance
                </label>
                <input 
                    type="date" 
                    id="newPatientDateNaissance" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                />
            </div>
            
            <div>
                <label for="newPatientTelephone" class="block text-sm font-medium text-gray-700 mb-1">
                    T√©l√©phone
                </label>
                <input 
                    type="tel" 
                    id="newPatientTelephone" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                    placeholder="06XXXXXXXX"
                />
            </div>
            
            <div>
                <label for="newPatientEmail" class="block text-sm font-medium text-gray-700 mb-1">
                    Email
                </label>
                <input 
                    type="email" 
                    id="newPatientEmail" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                />
            </div>
            
            <div class="flex gap-3 pt-4">
                <button 
                    type="button" 
                    onclick="closeCreatePatientModal()"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded-lg transition"
                >
                    Annuler
                </button>
                <button 
                    type="submit" 
                    class="flex-1 gradient-bg text-white font-semibold py-3 px-4 rounded-lg hover:opacity-90 transition"
                >
                    <i class="fas fa-save mr-2"></i>
                    Cr√©er
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Create M√©decin Modal -->
<div id="createMedecinModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-4 sm:p-6 rounded-t-lg">
            <h3 class="text-xl font-bold flex items-center">
                <i class="fas fa-user-plus mr-2"></i>
                Nouveau M√©decin
            </h3>
        </div>
        
        <form id="createMedecinForm" class="p-4 sm:p-6 space-y-4">
            <div>
                <label for="medecinNom" class="block text-sm font-medium text-gray-700 mb-1">
                    Nom <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="medecinNom" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                />
            </div>
            
            <div>
                <label for="medecinPrenom" class="block text-sm font-medium text-gray-700 mb-1">
                    Pr√©nom <span class="text-red-500">*</span>
                </label>
                <input 
                    type="text" 
                    id="medecinPrenom" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                />
            </div>
            
            <div>
                <label for="medecinSpecialite" class="block text-sm font-medium text-gray-700 mb-1">
                    Sp√©cialit√© <span class="text-red-500">*</span>
                </label>
                <select 
                    id="medecinSpecialite" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                >
                    <option value="">-- S√©lectionnez --</option>
                    <option value="Psychiatrie">Psychiatrie</option>
                    <option value="Psychologie Clinique">Psychologie Clinique</option>
                    <option value="Neuropsychiatrie">Neuropsychiatrie</option>
                    <option value="P√©dopsychiatrie">P√©dopsychiatrie</option>
                    <option value="Psychoth√©rapie">Psychoth√©rapie</option>
                </select>
            </div>
            
            <div>
                <label for="medecinTelephoneMod" class="block text-sm font-medium text-gray-700 mb-1">
                    T√©l√©phone
                </label>
                <input 
                    type="tel" 
                    id="medecinTelephoneMod" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="+212 6XXXXXXXX"
                />
            </div>
            
            <div>
                <label for="medecinEmailMod" class="block text-sm font-medium text-gray-700 mb-1">
                    Email
                </label>
                <input 
                    type="email" 
                    id="medecinEmailMod" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="medecin@clinique-lavallee.ma"
                />
            </div>
            
            <div class="flex gap-3 pt-4">
                <button 
                    type="button" 
                    onclick="closeCreateMedecinModal()"
                    class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-4 rounded-lg transition"
                >
                    Annuler
                </button>
                <button 
                    type="submit" 
                    class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg transition"
                >
                    <i class="fas fa-save mr-2"></i>
                    Cr√©er
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Search Form -->
<div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
    <form id="searchForm" class="space-y-3 sm:space-y-4">
        <input type="hidden" id="selectedPatientId" value="">
        <input type="hidden" id="selectedMedecinId" value="">
        
        <div>
            <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clipboard-list mr-1"></i> Description Clinique ou Question
            </label>
            <textarea 
                id="query" 
                name="query" 
                rows="4" 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                placeholder="Exemple: Un enfant sans maladie m√©dicale continue de passer les selles dans des endroits inappropri√©s malgr√© avoir √©t√© entra√Æn√© √† la propret√©..."
                required
            ></textarea>
        </div>
        
        <!-- Options cach√©es avec valeurs par d√©faut -->
        <input type="hidden" id="top_k" name="top_k" value="5">
        <input type="hidden" id="aggregation" name="aggregation" value="max">
        <input type="hidden" id="useValidation" name="useValidation" value="true">
        
        <button 
            type="submit" 
            class="w-full gradient-bg text-white font-semibold py-3 sm:py-4 px-6 rounded-lg hover:opacity-90 transition duration-200 flex items-center justify-center text-base sm:text-lg touch-action-manipulation"
        >
            <i class="fas fa-search mr-2"></i>
            Rechercher
        </button>
    </form>
</div>

<!-- Loading Indicator with Progress Bar -->
<div id="loadingIndicator" class="hidden bg-white rounded-lg shadow-md p-8 mb-8">
    <div class="space-y-6">
        <!-- Progress Header -->
    <div class="flex items-center justify-center">
            <i class="fas fa-search text-3xl text-purple-600 mr-3"></i>
            <h3 class="text-xl font-semibold text-gray-800">Recherche en cours...</h3>
        </div>
        
        <!-- Progress Bar -->
        <div class="w-full">
            <div class="w-full bg-gray-200 rounded-full h-4 mb-3 overflow-hidden">
                <div id="progressBar" class="h-4 rounded-full bg-gradient-to-r from-purple-500 to-blue-500 transition-all duration-300 ease-out" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
                <span id="progressPercentage">0%</span>
                <span id="progressStep">Initialisation...</span>
            </div>
        </div>
        
        <!-- Progress Steps -->
        <div class="grid grid-cols-4 gap-2">
            <div id="step1" class="progress-step text-center p-3 rounded-lg bg-gray-50">
                <i class="fas fa-file-search text-2xl text-gray-400 mb-2"></i>
                <p class="text-xs text-gray-600">Chargement</p>
            </div>
            <div id="step2" class="progress-step text-center p-3 rounded-lg bg-gray-50">
                <i class="fas fa-brain text-2xl text-gray-400 mb-2"></i>
                <p class="text-xs text-gray-600">Embedding</p>
            </div>
            <div id="step3" class="progress-step text-center p-3 rounded-lg bg-gray-50">
                <i class="fas fa-chart-line text-2xl text-gray-400 mb-2"></i>
                <p class="text-xs text-gray-600">Analyse</p>
            </div>
            <div id="step4" class="progress-step text-center p-3 rounded-lg bg-gray-50">
                <i class="fas fa-check-circle text-2xl text-gray-400 mb-2"></i>
                <p class="text-xs text-gray-600">R√©sultats</p>
            </div>
        </div>
        
        <!-- Files Counter -->
        <div class="text-center">
            <p class="text-sm text-gray-600">
                <i class="fas fa-file-medical mr-2"></i>
                <span id="filesProcessed">0</span> fichiers analys√©s
            </p>
        </div>
    </div>
</div>

<!-- Error Message -->
<div id="errorMessage" class="hidden bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded">
    <div class="flex">
        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
        <p class="text-red-700" id="errorText"></p>
    </div>
</div>

<!-- Diagnostic Summary -->
<div id="diagnosticSummary" class="hidden bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 mb-8 border-l-4 border-purple-500">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">
        <i class="fas fa-diagnoses mr-2"></i>
        R√©sum√© Diagnostique
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <p class="text-sm text-gray-600 mb-1">Pathologie Suspect√©e:</p>
            <p class="text-xl font-bold text-purple-700" id="suspectedPathology"></p>
        </div>
        <div>
            <p class="text-sm text-gray-600 mb-1">Niveau de Confiance:</p>
            <div class="flex items-center">
                <div class="flex-1 bg-gray-200 rounded-full h-4 mr-3">
                    <div id="confidenceBar" class="progress-bar h-4 rounded-full" style="width: 0%"></div>
                </div>
                <span id="confidenceText" class="text-lg font-bold"></span>
            </div>
        </div>
    </div>
    <div class="mt-4">
        <p class="text-sm text-gray-600 mb-1">Interpr√©tation:</p>
        <p class="text-gray-800" id="diagnosticMessage"></p>
    </div>
</div>

<!-- Results -->
<div id="results" class="space-y-6">
    <!-- Results will be inserted here -->
</div>

{% endblock %}

{% block extra_js %}
<script>
// Progress animation variables
let progressInterval;
let currentProgress = 0;
let filesCount = 0;

function updateProgress(percentage, step, stepText) {
    document.getElementById('progressBar').style.width = percentage + '%';
    document.getElementById('progressPercentage').textContent = percentage + '%';
    document.getElementById('progressStep').textContent = stepText;
    
    // Update step indicators
    for (let i = 1; i <= 4; i++) {
        const stepElement = document.getElementById('step' + i);
        const icon = stepElement.querySelector('i');
        const text = stepElement.querySelector('p');
        
        if (i < step) {
            // Completed step
            stepElement.className = 'progress-step text-center p-3 rounded-lg bg-green-50 border-2 border-green-500';
            icon.className = icon.className.replace('text-gray-400', 'text-green-500');
            text.className = 'text-xs text-green-700 font-semibold';
        } else if (i === step) {
            // Current step
            stepElement.className = 'progress-step text-center p-3 rounded-lg bg-purple-50 border-2 border-purple-500';
            icon.className = icon.className.replace('text-gray-400', 'text-purple-600') + ' fa-pulse';
            text.className = 'text-xs text-purple-700 font-semibold';
        } else {
            // Pending step
            stepElement.className = 'progress-step text-center p-3 rounded-lg bg-gray-50';
            icon.className = icon.className.replace('text-green-500', 'text-gray-400').replace('text-purple-600', 'text-gray-400').replace(' fa-pulse', '');
            text.className = 'text-xs text-gray-600';
        }
    }
}

function simulateProgress() {
    currentProgress = 0;
    filesCount = 0;
    
    // Reset progress
    updateProgress(0, 1, 'Initialisation...');
    document.getElementById('filesProcessed').textContent = '0';
    
    // Step 1: Loading (0-20%)
    setTimeout(() => {
        updateProgress(20, 1, 'Chargement des fichiers d\'embeddings...');
        filesCount = Math.floor(Math.random() * 10) + 5;
        document.getElementById('filesProcessed').textContent = filesCount;
    }, 300);
    
    // Step 2: Embedding (20-40%)
    setTimeout(() => {
        updateProgress(40, 2, 'G√©n√©ration de l\'embedding de la requ√™te...');
        filesCount += Math.floor(Math.random() * 20) + 10;
        document.getElementById('filesProcessed').textContent = filesCount;
    }, 800);
    
    // Step 3: Analysis (40-80%)
    setTimeout(() => {
        updateProgress(60, 3, 'Calcul des similarit√©s...');
        filesCount += Math.floor(Math.random() * 30) + 20;
        document.getElementById('filesProcessed').textContent = filesCount;
    }, 1400);
    
    setTimeout(() => {
        updateProgress(80, 3, 'Agr√©gation des r√©sultats...');
        filesCount += Math.floor(Math.random() * 40) + 30;
        document.getElementById('filesProcessed').textContent = filesCount;
    }, 2000);
    
    // Step 4: Results (80-95%)
    setTimeout(() => {
        updateProgress(95, 4, 'Pr√©paration des r√©sultats...');
    }, 2600);
}

function completeProgress() {
    updateProgress(100, 4, 'Recherche termin√©e !');
    setTimeout(() => {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }, 500);
}

document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const query = document.getElementById('query').value.trim();
    const top_k = document.getElementById('top_k').value;
    const aggregation = document.getElementById('aggregation').value;
    const useValidation = document.getElementById('useValidation').value === 'true';
    
    // Validation de la requ√™te - minimum 3 caract√®res
    if (query.length < 3) {
        Swal.fire({
            icon: 'warning',
            title: 'Requ√™te trop courte',
            text: 'Veuillez entrer au moins 3 caract√®res.',
            confirmButtonColor: '#667eea'
        });
        return;
    }
    
    // V√©rifier que ce n'est pas juste des caract√®res sp√©ciaux ou symboles
    const hasLetters = /[a-zA-Z√Ä-√ø]/.test(query);
    if (!hasLetters) {
        Swal.fire({
            icon: 'warning',
            title: 'Requ√™te invalide',
            text: 'Veuillez entrer des mots (lettres), pas seulement des symboles.',
            confirmButtonColor: '#667eea'
        });
        return;
    }
    
    // Show loading, hide errors and results
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('errorMessage').classList.add('hidden');
    document.getElementById('diagnosticSummary').classList.add('hidden');
    document.getElementById('results').innerHTML = '';
    
    // Start progress animation
    simulateProgress();
    
    try {
        const response = await fetch('{% url "pathology_search:search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                query, 
                top_k, 
                aggregation,
                use_validation: useValidation 
            })
        });
        
        const data = await response.json();
        
        // Complete progress and hide loading
        completeProgress();
        
        if (data.success) {
            // Si mode validation, rediriger vers la page de validation
            if (data.use_validation) {
                window.location.href = data.redirect_url;
                return;
            }
            
            // Sinon afficher les r√©sultats normalement
            // Update files count with actual number
            if (data.total_files_searched) {
                document.getElementById('filesProcessed').textContent = data.total_files_searched;
            }
            displayResults(data);
        } else {
            // V√©rifier si c'est une erreur de requ√™te invalide (validation GPT-4o)
            if (data.error_type === 'invalid_query') {
                document.getElementById('loadingIndicator').classList.add('hidden');
                Swal.fire({
                    icon: 'error',
                    title: 'Requ√™te Non Valide',
                    text: 'Votre requ√™te n\'est pas une description m√©dicale valide. Veuillez d√©crire des sympt√¥mes r√©els.',
                    confirmButtonText: 'R√©essayer',
                    confirmButtonColor: '#667eea'
                });
            }
            // V√©rifier si c'est une erreur de similarit√© faible
            else if (data.error_type === 'low_similarity') {
                document.getElementById('loadingIndicator').classList.add('hidden');
                Swal.fire({
                    icon: 'warning',
                    title: 'Correspondance Insuffisante',
                    html: `
                        <div class="text-left p-4">
                            <p class="text-gray-700 mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                La description fournie ne correspond √† aucune pathologie dans notre base de donn√©es.
                            </p>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>Score de correspondance :</strong> ${data.best_score ? data.best_score.toFixed(1) : 0}%
                                    <br>
                                    <strong>Seuil minimum requis :</strong> 60%
                                </p>
                            </div>
                            <p class="text-gray-700 font-semibold mb-2">Votre description pourrait √™tre :</p>
                            <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                                <li>‚ùå <strong>Incompl√®te</strong> : Manque de d√©tails cliniques importants</li>
                                <li>‚ùå <strong>Impr√©cise</strong> : Sympt√¥mes trop vagues ou g√©n√©raux</li>
                                <li>‚ùå <strong>Incorrecte</strong> : Ne correspond √† aucune pathologie connue</li>
                            </ul>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    <strong>Conseil :</strong> D√©crivez les sympt√¥mes de mani√®re pr√©cise et d√©taill√©e (dur√©e, fr√©quence, intensit√©, contexte).
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'R√©essayer',
                    confirmButtonColor: '#667eea',
                    width: '600px'
                });
        } else {
            showError(data.error);
            }
        }
    } catch (error) {
        document.getElementById('loadingIndicator').classList.add('hidden');
        showError('Erreur de connexion: ' + error.message);
    }
});

function displayResults(data) {
    const { results, diagnostic_info, total_files_searched } = data;
    
    if (!results || results.length === 0) {
        showError('Aucun r√©sultat trouv√©');
        return;
    }
    
    // Show diagnostic summary
    displayDiagnosticSummary(diagnostic_info);
    
    // Display results
    const resultsContainer = document.getElementById('results');
    
    const headerHTML = `
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">
                <i class="fas fa-file-medical mr-2"></i>
                Top ${results.length} Pathologies Correspondantes
            </h2>
            <p class="text-gray-600">
                <i class="fas fa-database mr-1"></i>
                ${total_files_searched} fichiers analys√©s
            </p>
        </div>
    `;
    
    resultsContainer.innerHTML = headerHTML;
    
    results.forEach((result, index) => {
        const card = createResultCard(result, index + 1);
        resultsContainer.innerHTML += card;
    });
}

function displayDiagnosticSummary(info) {
    document.getElementById('diagnosticSummary').classList.remove('hidden');
    document.getElementById('suspectedPathology').textContent = info.suspected_pathology || 'N/A';
    document.getElementById('confidenceText').textContent = `${info.confidence.toFixed(1)}%`;
    document.getElementById('diagnosticMessage').textContent = info.message;
    
    // Update confidence bar
    const bar = document.getElementById('confidenceBar');
    bar.style.width = `${info.confidence}%`;
    
    if (info.confidence_level === 'high') {
        bar.className = 'progress-bar h-4 rounded-full bg-green-500';
    } else if (info.confidence_level === 'moderate') {
        bar.className = 'progress-bar h-4 rounded-full bg-yellow-500';
    } else {
        bar.className = 'progress-bar h-4 rounded-full bg-red-500';
    }
}

function createResultCard(result, rank) {
    const similarity = result.similarity * 100;
    let confidenceClass, confidenceIcon, confidenceText;
    
    if (similarity >= 75) {
        confidenceClass = 'high';
        confidenceIcon = 'fa-check-circle text-green-500';
        confidenceText = 'FORTE CORRESPONDANCE';
    } else if (similarity >= 60) {
        confidenceClass = 'moderate';
        confidenceIcon = 'fa-exclamation-circle text-yellow-500';
        confidenceText = 'CORRESPONDANCE MOD√âR√âE';
    } else {
        confidenceClass = 'low';
        confidenceIcon = 'fa-times-circle text-red-500';
        confidenceText = 'CORRESPONDANCE FAIBLE';
    }
    
    const pathologyName = result.file_name.replace('.txt', '').replace(/_/g, ' ');
    const preview = result.best_chunk_text.substring(0, 300) + (result.best_chunk_text.length > 300 ? '...' : '');
    
    // Cr√©er le lien vers la page HTML si disponible
    const htmlLink = result.html_page ? `/pathology/${result.html_page}` : '#';
    const hasHtmlPage = result.html_page && result.html_page !== '';
    
    return `
        <div class="result-card ${confidenceClass} bg-white rounded-lg shadow-md p-4 sm:p-6 mb-4 card-hover">
            <!-- Mobile: Stack vertically, Desktop: Side by side -->
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between mb-4 gap-3">
                <div class="flex items-start flex-1 gap-3">
                    <div class="bg-purple-100 text-purple-700 rounded-full w-10 h-10 flex items-center justify-center font-bold flex-shrink-0">
                        ${rank}
                    </div>
                    <div class="flex-1 min-w-0">
                        ${hasHtmlPage ? `
                        <a href="${htmlLink}" target="_blank" class="group">
                            <h3 class="text-lg sm:text-xl font-bold text-gray-800 group-hover:text-purple-600 transition-colors flex items-center flex-wrap break-words">
                                <span class="break-words mr-2">${pathologyName}</span>
                                <i class="fas fa-external-link-alt text-xs sm:text-sm text-purple-500 group-hover:text-purple-700 flex-shrink-0"></i>
                            </h3>
                        </a>
                        ` : `
                        <h3 class="text-lg sm:text-xl font-bold text-gray-800 break-words">${pathologyName}</h3>
                        `}
                        <p class="text-xs sm:text-sm text-gray-500 mt-1">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            ${result.location || 'N/A'}
                        </p>
                    </div>
                </div>
                <div class="flex sm:flex-col items-center sm:items-end gap-2 sm:gap-1 justify-end sm:justify-start">
                    <i class="fas ${confidenceIcon} text-xl sm:text-2xl"></i>
                    <p class="text-xs font-semibold text-gray-600 uppercase text-right">${confidenceText}</p>
                </div>
            </div>
            
            <!-- Score de similarit√© -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs sm:text-sm text-gray-600">Score de similarit√©</span>
                    <span class="text-base sm:text-lg font-bold text-purple-700">${similarity.toFixed(1)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 sm:h-3">
                    <div class="h-2 sm:h-3 rounded-full ${confidenceClass === 'high' ? 'bg-green-500' : confidenceClass === 'moderate' ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${Math.min(similarity, 100)}%"></div>
                </div>
            </div>
            
            <!-- Extrait -->
            <div class="border-t pt-4">
                <p class="text-xs sm:text-sm text-gray-600 mb-2 font-semibold">
                    <i class="fas fa-quote-left mr-1"></i>
                    Extrait le plus pertinent (Chunk ${result.best_chunk_id + 1}/${result.num_chunks}):
                </p>
                <div class="bg-gray-50 rounded-lg p-3 sm:p-4">
                    <p class="text-gray-700 text-xs sm:text-sm italic leading-relaxed">${preview}</p>
                </div>
            </div>
            
            <!-- Informations fichier -->
            <div class="mt-4 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs sm:text-sm text-gray-500">
                <span class="flex items-center">
                    <i class="fas fa-book mr-1"></i>
                    ${result.num_chunks} sections analys√©es
                </span>
                <span class="flex items-center truncate">
                    <i class="fas fa-file-alt mr-1 flex-shrink-0"></i>
                    <span class="truncate">${result.file_name}</span>
                </span>
            </div>
            
            ${hasHtmlPage ? `
            <div class="mt-4 pt-4 border-t">
                <a href="${htmlLink}" target="_blank" class="block w-full text-center gradient-bg text-white font-semibold py-3 px-6 rounded-lg hover:opacity-90 transition duration-200 text-sm sm:text-base">
                    <i class="fas fa-file-medical-alt mr-2"></i>
                    Voir la Page Compl√®te de la Pathologie
                    <i class="fas fa-external-link-alt ml-2 text-xs"></i>
                </a>
            </div>
            ` : ''}
        </div>
    `;
}

function showError(message) {
    document.getElementById('errorMessage').classList.remove('hidden');
    document.getElementById('errorText').textContent = message;
}

function getCookie(name) {
    // Essayer d'abord de r√©cup√©rer depuis le meta tag
    if (name === 'csrftoken') {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        if (metaTag) {
            return metaTag.getAttribute('content');
        }
    }
    
    // Sinon, essayer depuis le cookie
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ============ GESTION DES PATIENTS ============

let currentPatients = [];
let selectedPatient = null;

// Charger la liste des patients, m√©decins et pathologies au chargement de la page
document.addEventListener('DOMContentLoaded', async function() {
    await loadPatients();
    await loadMedecins();
    await loadPathologies();
});

async function loadPatients() {
    try {
        const response = await fetch('/api/patients/');
        const data = await response.json();
        
        if (data.success) {
            currentPatients = data.patients;
            populatePatientSelect();
        }
    } catch (error) {
        console.error('Erreur lors du chargement des patients:', error);
    }
}

function populatePatientSelect() {
    const select = document.getElementById('patientSelect');
    // Garder la premi√®re option
    select.innerHTML = '<option value="">-- S√©lectionnez un patient --</option>';
    
    currentPatients.forEach(patient => {
        const option = document.createElement('option');
        option.value = patient.id;
        option.textContent = `${patient.nom_complet} (${patient.numero_dossier})`;
        option.dataset.patient = JSON.stringify(patient);
        select.appendChild(option);
    });
}

// G√©rer la s√©lection d'un patient
document.getElementById('patientSelect').addEventListener('change', async function(e) {
    const selectedOption = e.target.selectedOptions[0];
    
    if (selectedOption.value) {
        selectedPatient = JSON.parse(selectedOption.dataset.patient);
        document.getElementById('selectedPatientId').value = selectedPatient.id;
        
        // Afficher les informations du patient
        document.getElementById('patientNomComplet').textContent = selectedPatient.nom_complet;
        document.getElementById('patientNumeroDossier').textContent = selectedPatient.numero_dossier;
        document.getElementById('patientDateNaissanceDisplay').textContent = selectedPatient.date_naissance ? new Date(selectedPatient.date_naissance).toLocaleDateString('fr-FR') : 'Non renseign√©e';
        document.getElementById('patientTelephoneDisplay').textContent = selectedPatient.telephone || 'Non renseign√©';
        document.getElementById('patientEmailDisplay').textContent = selectedPatient.email || 'Non renseign√©';
        document.getElementById('patientInfo').classList.remove('hidden');
        
        // Charger l'historique du patient
        await loadPatientHistory(selectedPatient.id);
    } else {
        selectedPatient = null;
        document.getElementById('selectedPatientId').value = '';
        document.getElementById('patientInfo').classList.add('hidden');
        document.getElementById('patientHistory').classList.add('hidden');
    }
});

// Charger l'historique d'un patient
// Variable globale pour stocker les sympt√¥mes historiques du patient
let patientHistoricalSymptoms = [];

async function loadPatientHistory(patientId) {
    try {
        const response = await fetch(`/api/patients/${patientId}/history/`);
        const data = await response.json();
        
        if (data.success && data.consultations.length > 0) {
            // Stocker les sympt√¥mes historiques pour enrichir les futures recherches
            patientHistoricalSymptoms = data.all_symptoms || [];
            console.log(`üìä ${patientHistoricalSymptoms.length} sympt√¥mes historiques charg√©s pour ce patient`);
            
            // Afficher la section d'historique
            document.getElementById('patientHistory').classList.remove('hidden');
            document.getElementById('historyCount').textContent = `${data.consultations.length} consultation(s) - ${data.total_symptoms || 0} sympt√¥mes enregistr√©s`;
            
            // Remplir la liste des consultations
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            data.consultations.forEach(consultation => {
                const consultationDiv = document.createElement('div');
                
                // D√©terminer la couleur du badge selon le statut
                let statutBadgeClass = 'bg-gray-500';
                let statutIcon = 'fa-info-circle';
                if (consultation.statut === 'Valid√©') {
                    statutBadgeClass = 'bg-green-500';
                    statutIcon = 'fa-check-circle';
                } else if (consultation.statut === 'Non valid√©') {
                    statutBadgeClass = 'bg-orange-500';
                    statutIcon = 'fa-exclamation-circle';
                } else if (consultation.statut === 'En cours') {
                    statutBadgeClass = 'bg-blue-500';
                    statutIcon = 'fa-clock';
                }
                
                consultationDiv.className = 'bg-gray-50 rounded-lg border border-gray-200 overflow-hidden';
                
                const hasDetails = consultation.nombre_criteres > 0 || consultation.medecin_specialite;
                const uniqueId = `consultation_${consultation.id}`;
                
                consultationDiv.innerHTML = `
                    <div class="p-3 hover:bg-gray-100 transition ${hasDetails ? 'cursor-pointer' : ''}" ${hasDetails ? `onclick="toggleConsultationDetails('${uniqueId}')"` : ''}>
                        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    ${hasDetails ? '<i class="fas fa-chevron-down text-xs text-gray-400 consultation-toggle" id="toggle_' + uniqueId + '"></i>' : ''}
                                    <i class="fas fa-calendar-alt text-blue-600 text-sm"></i>
                                    <span class="font-semibold text-gray-800 text-sm">${consultation.date_consultation}</span>
                                    <span class="${statutBadgeClass} text-white text-xs px-2 py-1 rounded-full inline-flex items-center gap-1">
                                        <i class="fas ${statutIcon}"></i>
                                        ${consultation.statut}
                                    </span>
                                </div>
                                <div class="text-sm text-gray-600 ml-5">
                                    <i class="fas fa-diagnoses mr-1"></i>
                                    ${consultation.pathologie_identifiee || 'Non renseign√©'}
                                </div>
                                <div class="text-xs text-gray-500 ml-5 mt-1">
                                    <i class="fas fa-user-doctor mr-1"></i>
                                    ${consultation.medecin}${consultation.medecin_specialite ? ' - ' + consultation.medecin_specialite : ''}
                                </div>
                                ${consultation.nombre_criteres > 0 ? `
                                <div class="text-xs text-purple-600 ml-5 mt-1 font-medium">
                                    <i class="fas fa-list-check mr-1"></i>
                                    ${consultation.nombre_criteres} crit√®re(s) enregistr√©(s)
                                </div>
                                ` : ''}
                            </div>
                            ${consultation.statut === 'Valid√©' ? `
                            <button 
                                onclick="event.stopPropagation(); viewReport('${consultation.id}')"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 whitespace-nowrap"
                            >
                                <i class="fas fa-file-pdf"></i>
                                Voir le rapport
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    ${hasDetails ? `
                    <div id="${uniqueId}" class="hidden border-t border-gray-300 bg-white p-3">
                        ${consultation.description_clinique ? `
                        <div class="mb-2">
                            <span class="text-xs font-semibold text-gray-700">Description clinique:</span>
                            <p class="text-xs text-gray-600 mt-1">${consultation.description_clinique}</p>
                        </div>
                        ` : ''}
                        ${consultation.criteres_valides && consultation.criteres_valides.length > 0 ? `
                        <div>
                            <span class="text-xs font-semibold text-gray-700">Crit√®res valid√©s:</span>
                            <ul class="list-disc list-inside text-xs text-gray-600 mt-1 space-y-1">
                                ${consultation.criteres_valides.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                `;
                historyList.appendChild(consultationDiv);
            });
        } else {
            // Cacher la section d'historique si aucune consultation
            document.getElementById('patientHistory').classList.add('hidden');
            patientHistoricalSymptoms = [];
        }
    } catch (error) {
        console.error('Erreur lors du chargement de l\'historique:', error);
        document.getElementById('patientHistory').classList.add('hidden');
        patientHistoricalSymptoms = [];
    }
}

// Fonction pour afficher/masquer les d√©tails d'une consultation (accord√©on)
function toggleConsultationDetails(uniqueId) {
    const detailsDiv = document.getElementById(uniqueId);
    const toggleIcon = document.getElementById('toggle_' + uniqueId);
    
    if (detailsDiv) {
        detailsDiv.classList.toggle('hidden');
        if (toggleIcon) {
            if (detailsDiv.classList.contains('hidden')) {
                toggleIcon.classList.remove('fa-chevron-up');
                toggleIcon.classList.add('fa-chevron-down');
            } else {
                toggleIcon.classList.remove('fa-chevron-down');
                toggleIcon.classList.add('fa-chevron-up');
            }
        }
    }
}

// Fonction pour voir un rapport
function viewReport(consultationId) {
    // Ouvrir le rapport dans un nouvel onglet
    window.open(`/print/${consultationId}/`, '_blank');
}

// Modal de cr√©ation de patient
function openCreatePatientModal() {
    document.getElementById('createPatientModal').classList.remove('hidden');
}

function closeCreatePatientModal() {
    document.getElementById('createPatientModal').classList.add('hidden');
    document.getElementById('createPatientForm').reset();
}

// Cr√©er un nouveau patient
document.getElementById('createPatientForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const patientData = {
        nom: document.getElementById('patientNom').value,
        prenom: document.getElementById('patientPrenom').value,
        date_naissance: document.getElementById('newPatientDateNaissance').value || null,
        telephone: document.getElementById('newPatientTelephone').value,
        email: document.getElementById('newPatientEmail').value
    };
    
    try {
        const response = await fetch('/api/patients/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(patientData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'Patient cr√©√© !',
                text: `${data.patient.nom_complet} a √©t√© ajout√© avec le n¬∞ ${data.patient.numero_dossier}`,
                confirmButtonColor: '#667eea'
            });
            
            // Recharger la liste des patients
            await loadPatients();
            
            // S√©lectionner automatiquement le nouveau patient
            document.getElementById('patientSelect').value = data.patient.id;
            document.getElementById('patientSelect').dispatchEvent(new Event('change'));
            
            // Fermer le modal
            closeCreatePatientModal();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: data.error,
                confirmButtonColor: '#667eea'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Erreur lors de la cr√©ation du patient: ' + error.message,
            confirmButtonColor: '#667eea'
        });
    }
});

// ===== GESTION DES M√âDECINS =====
let currentMedecins = [];
let selectedMedecin = null;

async function loadMedecins() {
    try {
        const response = await fetch('/api/medecins/');
        const data = await response.json();
        
        if (data.success) {
            currentMedecins = data.medecins;
            populateMedecinSelect();
        }
    } catch (error) {
        console.error('Erreur lors du chargement des m√©decins:', error);
    }
}

function populateMedecinSelect() {
    const select = document.getElementById('medecinSelect');
    select.innerHTML = '<option value="">-- S√©lectionnez un m√©decin --</option>';
    
    currentMedecins.forEach(medecin => {
        const option = document.createElement('option');
        option.value = medecin.id;
        option.textContent = `${medecin.nom_complet} - ${medecin.specialite}`;
        option.dataset.medecin = JSON.stringify(medecin);
        select.appendChild(option);
    });
}

// G√©rer la s√©lection d'un m√©decin
document.getElementById('medecinSelect').addEventListener('change', function(e) {
    const selectedOption = e.target.selectedOptions[0];
    
    if (selectedOption.value) {
        selectedMedecin = JSON.parse(selectedOption.dataset.medecin);
        document.getElementById('selectedMedecinId').value = selectedMedecin.id;
        
        // Afficher les informations du m√©decin
        document.getElementById('medecinNomComplet').textContent = selectedMedecin.nom_complet;
        document.getElementById('medecinSpecialiteDisplay').textContent = selectedMedecin.specialite;
        document.getElementById('medecinNumeroOrdreDisplay').textContent = selectedMedecin.numero_ordre;
        document.getElementById('medecinTelephoneDisplay').textContent = selectedMedecin.telephone || 'Non renseign√©';
        document.getElementById('medecinInfo').classList.remove('hidden');
    } else {
        selectedMedecin = null;
        document.getElementById('selectedMedecinId').value = '';
        document.getElementById('medecinInfo').classList.add('hidden');
    }
});

// Modal de cr√©ation de m√©decin
function openCreateMedecinModal() {
    document.getElementById('createMedecinModal').classList.remove('hidden');
}

function closeCreateMedecinModal() {
    document.getElementById('createMedecinModal').classList.add('hidden');
    document.getElementById('createMedecinForm').reset();
}

// G√©rer la cr√©ation d'un m√©decin
document.getElementById('createMedecinForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const medecinData = {
        nom: document.getElementById('medecinNom').value,
        prenom: document.getElementById('medecinPrenom').value,
        specialite: document.getElementById('medecinSpecialite').value,
        telephone: document.getElementById('medecinTelephoneMod').value,
        email: document.getElementById('medecinEmailMod').value
    };
    
    try {
        const response = await fetch('/api/medecins/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(medecinData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            Swal.fire({
                icon: 'success',
                title: 'M√©decin cr√©√© !',
                text: `${data.medecin.nom_complet} a √©t√© cr√©√© avec succ√®s.`,
                confirmButtonColor: '#667eea',
                timer: 2000,
                timerProgressBar: true
            });
            
            // Recharger la liste des m√©decins
            await loadMedecins();
            
            // S√©lectionner automatiquement le nouveau m√©decin
            document.getElementById('medecinSelect').value = data.medecin.id;
            document.getElementById('medecinSelect').dispatchEvent(new Event('change'));
            
            // Fermer le modal
            closeCreateMedecinModal();
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: data.error,
                confirmButtonColor: '#667eea'
            });
        }
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Erreur',
            text: 'Erreur lors de la cr√©ation du m√©decin: ' + error.message,
            confirmButtonColor: '#667eea'
        });
    }
});

// ============================================
// Gestion des Pathologies - Acc√®s Direct
// ============================================

let allPathologies = [];

// Charger toutes les pathologies
async function loadPathologies() {
    try {
        const response = await fetch('/api/pathologies/');
        const data = await response.json();
        
        if (data.success) {
            allPathologies = data.pathologies;
            populatePathologySelect();
        }
    } catch (error) {
        console.error('Erreur lors du chargement des pathologies:', error);
    }
}

function populatePathologySelect() {
    const select = document.getElementById('pathologySelect');
    select.innerHTML = '<option value="">-- S√©lectionnez une pathologie --</option>';
    
    allPathologies.forEach((pathology, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = pathology.name;
        option.dataset.pathology = JSON.stringify(pathology);
        select.appendChild(option);
    });
}

// G√©rer la s√©lection d'une pathologie
document.getElementById('pathologySelect').addEventListener('change', function(e) {
    const selectedOption = e.target.selectedOptions[0];
    
    if (selectedOption.value) {
        const pathology = JSON.parse(selectedOption.dataset.pathology);
        
        // Afficher les informations de localisation
        document.getElementById('pathologyLocation').textContent = pathology.location;
        document.getElementById('pathologyInfo').classList.remove('hidden');
    } else {
        document.getElementById('pathologyInfo').classList.add('hidden');
    }
});

// Acc√©der directement au formulaire de la pathologie
function accessPathology() {
    const select = document.getElementById('pathologySelect');
    const selectedOption = select.selectedOptions[0];
    
    if (!selectedOption.value) {
        Swal.fire({
            icon: 'warning',
            title: 'Aucune pathologie s√©lectionn√©e',
            text: 'Veuillez s√©lectionner une pathologie avant de continuer.',
            confirmButtonColor: '#10b981'
        });
        return;
    }
    
    const pathology = JSON.parse(selectedOption.dataset.pathology);
    
    // V√©rifier qu'un patient est s√©lectionn√©
    if (!selectedPatient) {
        Swal.fire({
            icon: 'warning',
            title: 'Patient requis',
            text: 'Veuillez s√©lectionner un patient avant d\'acc√©der √† une pathologie.',
            confirmButtonColor: '#10b981'
        });
        return;
    }
    
    // Construire l'URL vers la page de la pathologie avec mode direct
    const pathologyUrl = `/direct-access/?html_page=${encodeURIComponent(pathology.html_page)}&patient_id=${selectedPatient.id}${selectedMedecin ? '&medecin_id=' + selectedMedecin.id : ''}`;
    
    // Afficher une confirmation avant redirection
    Swal.fire({
        icon: 'info',
        title: 'Ouverture du formulaire',
        html: `
            <p class="mb-2">Vous allez acc√©der au formulaire d'√©valuation pour :</p>
            <p class="font-bold text-lg text-purple-600">${pathology.name}</p>
        `,
        showCancelButton: true,
        confirmButtonText: '<i class="fas fa-arrow-right mr-2"></i>Continuer',
        cancelButtonText: 'Annuler',
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#6b7280',
        timer: 5000,
        timerProgressBar: true
    }).then((result) => {
        if (result.isConfirmed) {
            // Rediriger vers la page de la pathologie
            window.location.href = pathologyUrl;
        }
    });
}

// Modifier la validation du formulaire de recherche pour inclure le patient et le m√©decin
const originalSearchFormSubmit = document.getElementById('searchForm').onsubmit;
document.getElementById('searchForm').onsubmit = null;

document.getElementById('searchForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // V√©rifier qu'un patient est s√©lectionn√©
    if (!selectedPatient) {
        Swal.fire({
            icon: 'warning',
            title: 'Patient requis',
            text: 'Veuillez s√©lectionner un patient avant de lancer la recherche.',
            confirmButtonColor: '#667eea'
        });
        return;
    }
    
    const query = document.getElementById('query').value.trim();
    const top_k = document.getElementById('top_k').value;
    const aggregation = document.getElementById('aggregation').value;
    const useValidation = document.getElementById('useValidation').value === 'true';
    
    // Validation de la requ√™te - minimum 3 caract√®res
    if (query.length < 3) {
        Swal.fire({
            icon: 'warning',
            title: 'Requ√™te trop courte',
            text: 'Veuillez entrer au moins 3 caract√®res.',
            confirmButtonColor: '#667eea'
        });
        return;
    }
    
    // V√©rifier que ce n'est pas juste des caract√®res sp√©ciaux ou symboles
    const hasLetters = /[a-zA-Z√Ä-√ø]/.test(query);
    if (!hasLetters) {
        Swal.fire({
            icon: 'warning',
            title: 'Requ√™te invalide',
            text: 'Veuillez entrer des mots (lettres), pas seulement des symboles.',
            confirmButtonColor: '#667eea'
        });
        return;
    }
    
    // üÜï Afficher notification si historique disponible (l'enrichissement se fait en BACKEND)
    if (patientHistoricalSymptoms && patientHistoricalSymptoms.length > 0) {
        console.log(`üìä Envoi de ${patientHistoricalSymptoms.length} sympt√¥mes historiques au backend`);
        Swal.fire({
            icon: 'info',
            title: 'Recherche enrichie',
            html: `La recherche inclut <strong>${patientHistoricalSymptoms.length} sympt√¥mes</strong> de l'historique du patient`,
            timer: 2000,
            timerProgressBar: true,
            showConfirmButton: false
        });
    }
    
    // Show loading, hide errors and results
    document.getElementById('loadingIndicator').classList.remove('hidden');
    document.getElementById('errorMessage').classList.add('hidden');
    document.getElementById('diagnosticSummary').classList.add('hidden');
    document.getElementById('results').innerHTML = '';
    
    // Start progress animation
    simulateProgress();
    
    try {
        const response = await fetch('{% url "pathology_search:search" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ 
                query: query,  // üÜï Envoyer la requ√™te ORIGINALE (enrichissement en backend)
                top_k, 
                aggregation,
                use_validation: useValidation,
                patient_id: selectedPatient.id,
                medecin_id: selectedMedecin ? selectedMedecin.id : null,
                historical_symptoms: patientHistoricalSymptoms  // üÜï Le backend va enrichir avec √ßa
            })
        });
        
        const data = await response.json();
        
        // Complete progress and hide loading
        completeProgress();
        
        if (data.success) {
            // Si mode validation, rediriger vers la page de validation
            if (data.use_validation) {
                window.location.href = data.redirect_url;
                return;
            }
            
            // Sinon afficher les r√©sultats normalement
            // Update files count with actual number
            if (data.total_files_searched) {
                document.getElementById('filesProcessed').textContent = data.total_files_searched;
            }
            displayResults(data);
        } else {
            // V√©rifier si c'est une erreur de requ√™te invalide (validation GPT-4o)
            if (data.error_type === 'invalid_query') {
                document.getElementById('loadingIndicator').classList.add('hidden');
                Swal.fire({
                    icon: 'error',
                    title: 'Requ√™te Non Valide',
                    text: 'Votre requ√™te n\'est pas une description m√©dicale valide. Veuillez d√©crire des sympt√¥mes r√©els.',
                    confirmButtonText: 'R√©essayer',
                    confirmButtonColor: '#667eea'
                });
            }
            // V√©rifier si c'est une erreur de similarit√© faible
            else if (data.error_type === 'low_similarity') {
                document.getElementById('loadingIndicator').classList.add('hidden');
                Swal.fire({
                    icon: 'warning',
                    title: 'Correspondance Insuffisante',
                    html: `
                        <div class="text-left p-4">
                            <p class="text-gray-700 mb-4">
                                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                                La description fournie ne correspond √† aucune pathologie dans notre base de donn√©es.
                            </p>
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                                <p class="text-sm text-yellow-800">
                                    <strong>Score de correspondance :</strong> ${data.best_score ? data.best_score.toFixed(1) : 0}%
                                    <br>
                                    <strong>Seuil minimum requis :</strong> 60%
                                </p>
                            </div>
                            <p class="text-gray-700 font-semibold mb-2">Votre description pourrait √™tre :</p>
                            <ul class="list-disc list-inside text-gray-600 space-y-1 ml-2">
                                <li>‚ùå <strong>Incompl√®te</strong> : Manque de d√©tails cliniques importants</li>
                                <li>‚ùå <strong>Impr√©cise</strong> : Sympt√¥mes trop vagues ou g√©n√©raux</li>
                                <li>‚ùå <strong>Incorrecte</strong> : Ne correspond √† aucune pathologie connue</li>
                            </ul>
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <i class="fas fa-lightbulb mr-2"></i>
                                    <strong>Conseil :</strong> D√©crivez les sympt√¥mes de mani√®re pr√©cise et d√©taill√©e (dur√©e, fr√©quence, intensit√©, contexte).
                                </p>
                            </div>
                        </div>
                    `,
                    confirmButtonText: 'R√©essayer',
                    confirmButtonColor: '#667eea',
                    width: '600px'
                });
            } else {
                showError(data.error);
            }
        }
    } catch (error) {
        document.getElementById('loadingIndicator').classList.add('hidden');
        showError('Erreur de connexion: ' + error.message);
    }
});

</script>
{% endblock %}

